<script>
    // --- DATABASE ---
    const initialData = [
        { type: 'tech', title: "Contoh Data (Reset)", content: "Data ini muncul karena database kosong.", model: "Test", category: "System" }
    ];

    let kbData = JSON.parse(localStorage.getItem('reiwa_kb_v3')) || initialData;
    let currentTab = 'tech';

    // Elements
    const views = {
        view: document.getElementById('view-area'),
        add: document.getElementById('add-section'),
        setting: document.getElementById('setting-section')
    };
    const titleEl = document.getElementById('page-title');
    const searchInput = document.getElementById('search');
    const grid = document.getElementById('results-grid');

    // PDF Worker Setup
    if (typeof pdfjsLib !== 'undefined') {
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js';
    }

    // --- CSV IMPORT YANG DIPERBAIKI (ANTI GAGAL) ---
    function handleCsvUpload(input) {
        const file = input.files[0];
        if (!file) return;

        // Gunakan FileReader untuk membaca teks dulu agar bisa deteksi separator
        const reader = new FileReader();
        reader.onload = function(e) {
            const text = e.target.result;
            
            // Deteksi otomatis separator (; atau ,)
            const firstLine = text.split('\n')[0];
            const separator = firstLine.includes(';') ? ';' : ',';
            
            Papa.parse(text, {
                header: true,
                skipEmptyLines: true,
                delimiter: separator, // Pakai separator yang dideteksi
                transformHeader: function(h) {
                    return h.trim().toLowerCase(); // Paksa header jadi huruf kecil & hapus spasi
                },
                complete: function(results) {
                    const newData = results.data;
                    let count = 0;
                    
                    if (newData.length === 0) {
                        alert("File terbaca tapi kosong. Pastikan format Excel benar.");
                        return;
                    }

                    // Debugging: Cek kolom pertama
                    console.log("Kolom yang terbaca:", Object.keys(newData[0]));

                    newData.forEach(row => {
                        // Cek variasi nama kolom agar lebih fleksibel
                        // Mengatasi masalah jika user nulis "Content" atau "Isi" atau "Jawaban"
                        const type = row.type || row.jenis || 'tech';
                        const title = row.title || row.judul || row.pertanyaan;
                        const content = row.content || row.isi || row.jawaban || row.solusi;
                        const model = row.model || 'General';
                        const category = row.category || row.kategori || 'General';

                        if (title && content) {
                            kbData.push({
                                type: type.toLowerCase().trim().includes('wa') ? 'wa' : 'tech', // Auto detect WA/Tech
                                title: title,
                                model: model,
                                category: category,
                                content: content
                            });
                            count++;
                        }
                    });

                    if (count > 0) {
                        saveToStorage();
                        showToast(`Berhasil! ${count} data baru ditambahkan.`);
                        switchTab('tech');
                    } else {
                        alert("Gagal import! Pastikan Excel punya kolom: 'Title' dan 'Content'.\n(Cek console log untuk detail).");
                    }
                },
                error: function(err) {
                    alert("Error Parsing: " + err.message);
                }
            });
        };
        reader.readAsText(file);
    }

    // --- NAVIGATION & RENDER ---
    function switchTab(tab) {
        currentTab = tab;
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        Object.values(views).forEach(el => el.style.display = 'none');

        if(tab === 'add') {
            views.add.style.display = 'block';
            document.querySelector('.add-mode').classList.add('active');
        } else if (tab === 'setting') {
            views.setting.style.display = 'block';
            document.getElementById('total-data').innerText = kbData.length;
            document.querySelector('.setting-mode').classList.add('active');
        } else {
            views.view.style.display = 'block';
            if(tab === 'tech') {
                titleEl.innerText = "ðŸ› ï¸ Knowledge Base";
                document.querySelectorAll('.nav-btn')[0].classList.add('active');
            } else {
                titleEl.innerText = "ðŸ’¬ Template WA";
                document.querySelectorAll('.nav-btn')[1].classList.add('active');
            }
            renderData();
        }
    }

    function renderData() {
        const query = searchInput.value.toLowerCase();
        const filtered = kbData.filter(item => {
            return item.type === currentTab && (
                (item.title && item.title.toLowerCase().includes(query)) || 
                (item.content && item.content.toLowerCase().includes(query)) ||
                (item.model && item.model.toLowerCase().includes(query))
            );
        });

        document.getElementById('result-count').innerText = `${filtered.length} Data`;
        grid.innerHTML = '';

        if(filtered.length === 0) {
            grid.innerHTML = '<div style="text-align:center; padding:40px; color:#999;">Tidak ada data.</div>';
            return;
        }

        filtered.forEach((item, index) => {
            const originalIndex = kbData.indexOf(item);
            const card = document.createElement('div');
            card.className = `card type-${item.type}`;
            card.innerHTML = `
                <button class="btn-delete" onclick="deleteItem(${originalIndex})" title="Hapus">&times;</button>
                <div class="card-header">
                    <div class="card-title">${item.title}</div>
                    <div><span class="badge badge-model">${item.model}</span></div>
                </div>
                <div class="card-content">${item.content.replace(/\n/g, '<br>')}</div>
                <button class="btn-copy" onclick="copyText(this)">ðŸ“‹ Salin</button>
            `;
            grid.appendChild(card);
        });
    }

    // --- PDF IMPORT ---
    async function handlePdfUpload(input) {
        const file = input.files[0];
        if (!file) return;
        const loader = document.getElementById('pdfLoader');
        loader.style.display = 'block';
        const fileReader = new FileReader();
        fileReader.onload = async function() {
            const typedarray = new Uint8Array(this.result);
            try {
                const pdf = await pdfjsLib.getDocument(typedarray).promise;
                let fullText = "";
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    fullText += textContent.items.map(item => item.str).join(' ') + "\n\n";
                }
                document.getElementById('new-title').value = "Hasil PDF: " + file.name;
                document.getElementById('new-model').value = "PDF Import";
                document.getElementById('new-content').value = fullText;
                showToast("PDF terbaca! Silakan edit.");
            } catch (error) { alert("Gagal baca PDF: " + error.message); } 
            finally { loader.style.display = 'none'; }
        };
        fileReader.readAsArrayBuffer(file);
    }

    // --- CRUD FUNCTIONS ---
    function saveData(e) {
        e.preventDefault();
        const newItem = {
            type: document.getElementById('new-type').value,
            title: document.getElementById('new-title').value,
            model: document.getElementById('new-model').value,
            content: document.getElementById('new-content').value
        };
        kbData.push(newItem);
        saveToStorage();
        document.getElementById('addForm').reset();
        showToast("Tersimpan!");
        switchTab(newItem.type);
    }

    function deleteItem(index) {
        if(confirm('Hapus data ini?')) { kbData.splice(index, 1); saveToStorage(); renderData(); }
    }

    function clearAllData() {
        if(confirm('YAKIN HAPUS SEMUA?')) { kbData = []; saveToStorage(); location.reload(); }
    }

    function saveToStorage() { localStorage.setItem('reiwa_kb_v3', JSON.stringify(kbData)); }
    function copyText(btn) { navigator.clipboard.writeText(btn.previousElementSibling.innerText).then(() => showToast("Teks disalin!")); }
    function showToast(msg) { const t = document.getElementById('toast'); t.innerText = msg; t.className = "show"; setTimeout(() => t.className = "", 3000); }

    searchInput.addEventListener('input', renderData);
    switchTab('tech');
</script>